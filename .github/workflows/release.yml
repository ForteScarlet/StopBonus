name: Release
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CONVEYOR_VERSION: 21.0.0
  CONVEYOR_ROOT_KEY: ${{ secrets.CONVEYOR_ROOT_KEY }}
  CONVEYOR_KEY_PASSPHRASE: ${{ secrets.CONVEYOR_KEY_PASSPHRASE }}

jobs:
  release:
    name: Build & publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: gradle/wrapper-validation-action@v3

      - uses: actions/setup-java@v5
        with:
          distribution: jetbrains
          java-version: 21

      - uses: gradle/actions/setup-gradle@v5

      - uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Write signing key file
        run: echo "${{ env.CONVEYOR_ROOT_KEY }}" > signkey.gpg

      - name: Install Conveyor CLI
        run: npm i -g --no-fund --no-audit @hydraulic/conveyor@${CONVEYOR_VERSION}

      - name: Build packages + update site
        shell: bash
        run: |
          set -euxo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          CONVEYOR_AGREE_TO_LICENSE=1 ./gradlew --no-daemon --stacktrace -PappVersion="$VERSION" conveyCi

      - name: Upload build output (for debugging)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: conveyor-site-and-packages
          retention-days: 7
          path: |
            build/packages/**

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            build/packages/**/*.zip
            build/packages/**/*.tar.gz
            build/packages/**/*.deb
            build/packages/**/*.msix
            build/packages/**/*.appinstaller
            build/packages/**/*.crt
            build/packages/**/*.exe
          body: |
            ## 下载说明

            | 文件 | 系统平台 | 类型/用途 |
            |------|----------|----------|
            | `stopbonus-*-windows-amd64.zip` | Windows | 免安装 |
            | `stopbonus-*.x64.msix` + `stopbonus.appinstaller` | Windows | MSIX 安装/更新 |
            | `stopbonus.exe` | Windows | 安装器 |
            | `stopbonus-*-mac-*.zip` | macOS | 免安装（.app） |
            | `stopbonus-*-linux-amd64.tar.gz` | Linux | 免安装 |
            | `debian/*.deb` | Debian/Ubuntu | 安装包 |

      - name: Prepare GitHub Pages content
        run: touch build/packages/.nojekyll

      - name: Publish update site to GitHub Pages (gh-pages)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/packages
          publish_branch: gh-pages
          force_orphan: true
